name: ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå†’çƒŸæµ‹è¯•
    - cron: '0 2 * * *'

jobs:
  # å†’çƒŸæµ‹è¯• - å¿«é€ŸéªŒè¯æ ¸å¿ƒåŠŸèƒ½
  smoke-tests:
    name: ğŸ”¥ å†’çƒŸæµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ“¦ è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ³ å¯åŠ¨æ•°æ®åº“æœåŠ¡
      run: |
        docker-compose -f docker-compose.dev.yml up -d postgres redis minio
        sleep 10
        
    - name: ğŸ—ï¸ æ„å»ºåç«¯
      run: |
        cd nz-market-backend
        mvn clean compile -DskipTests
        
    - name: ğŸš€ å¯åŠ¨åç«¯æœåŠ¡
      run: |
        cd nz-market-backend
        mvn spring-boot:run -DskipTests &
        sleep 30
        
    - name: ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–
      run: |
        cd nz-market-frontend
        npm install
        
    - name: ğŸš€ å¯åŠ¨å‰ç«¯æœåŠ¡
      run: |
        cd nz-market-frontend
        npm run dev &
        sleep 10
        
    - name: ğŸ§ª å®‰è£…æµ‹è¯•ä¾èµ–
      run: |
        npm install @playwright/test
        npx playwright install --with-deps
        
    - name: ğŸ”¥ è¿è¡Œå†’çƒŸæµ‹è¯•
      run: |
        npx playwright test --grep "å†’çƒŸ" --project=chromium --workers=1
      env:
        CI: true
        
    - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: smoke-test-results
        path: test-results/

  # å®Œæ•´æµ‹è¯•å¥—ä»¶
  full-tests:
    name: ğŸ§ª å®Œæ•´æµ‹è¯•å¥—ä»¶
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: smoke-tests
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ“¦ è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ³ å¯åŠ¨æ•°æ®åº“æœåŠ¡
      run: |
        docker-compose -f docker-compose.dev.yml up -d postgres redis minio
        sleep 15
        
    - name: ğŸ—ï¸ æ„å»ºåç«¯
      run: |
        cd nz-market-backend
        mvn clean compile -DskipTests
        
    - name: ğŸš€ å¯åŠ¨åç«¯æœåŠ¡
      run: |
        cd nz-market-backend
        mvn spring-boot:run -DskipTests &
        sleep 45
        
    - name: ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–
      run: |
        cd nz-market-frontend
        npm install
        
    - name: ğŸš€ å¯åŠ¨å‰ç«¯æœåŠ¡
      run: |
        cd nz-market-frontend
        npm run dev &
        sleep 15
        
    - name: ğŸ§ª å®‰è£…æµ‹è¯•ä¾èµ–
      run: |
        npm install @playwright/test
        npx playwright install --with-deps
        
    - name: ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•
      run: |
        npx playwright test --project=${{ matrix.browser }} --workers=2
      env:
        CI: true
        
    - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.browser }}
        path: test-results/

  # APIæµ‹è¯•
  api-tests:
    name: ğŸ”Œ APIæ¥å£æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ“¦ è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ³ å¯åŠ¨æ•°æ®åº“æœåŠ¡
      run: |
        docker-compose -f docker-compose.dev.yml up -d postgres redis minio
        sleep 10
        
    - name: ğŸ—ï¸ æ„å»ºåç«¯
      run: |
        cd nz-market-backend
        mvn clean compile -DskipTests
        
    - name: ğŸš€ å¯åŠ¨åç«¯æœåŠ¡
      run: |
        cd nz-market-backend
        mvn spring-boot:run -DskipTests &
        sleep 30
        
    - name: ğŸ§ª å®‰è£…æµ‹è¯•ä¾èµ–
      run: |
        npm install @playwright/test
        npx playwright install --with-deps
        
    - name: ğŸ”Œ è¿è¡ŒAPIæµ‹è¯•
      run: |
        npx playwright test --grep "API" --project=chromium
      env:
        CI: true
        
    - name: ğŸ“Š ä¸Šä¼ APIæµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: api-test-results
        path: test-results/

  # æ€§èƒ½æµ‹è¯•
  performance-tests:
    name: âš¡ æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ“¦ è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ³ å¯åŠ¨æ•°æ®åº“æœåŠ¡
      run: |
        docker-compose -f docker-compose.dev.yml up -d postgres redis minio
        sleep 10
        
    - name: ğŸ—ï¸ æ„å»ºåç«¯
      run: |
        cd nz-market-backend
        mvn clean compile -DskipTests
        
    - name: ğŸš€ å¯åŠ¨åç«¯æœåŠ¡
      run: |
        cd nz-market-backend
        mvn spring-boot:run -DskipTests &
        sleep 30
        
    - name: ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–
      run: |
        cd nz-market-frontend
        npm install
        
    - name: ğŸš€ å¯åŠ¨å‰ç«¯æœåŠ¡
      run: |
        cd nz-market-frontend
        npm run dev &
        sleep 10
        
    - name: ğŸ§ª å®‰è£…æµ‹è¯•ä¾èµ–
      run: |
        npm install @playwright/test
        npx playwright install --with-deps
        
    - name: âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•
      run: |
        npx playwright test --grep "æ€§èƒ½" --project=chromium
      env:
        CI: true
        
    - name: ğŸ“Š ä¸Šä¼ æ€§èƒ½æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-test-results
        path: test-results/

  # æµ‹è¯•æŠ¥å‘Šæ±‡æ€»
  test-summary:
    name: ğŸ“Š æµ‹è¯•æŠ¥å‘Šæ±‡æ€»
    runs-on: ubuntu-latest
    needs: [smoke-tests, full-tests, api-tests]
    if: always()
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“Š ä¸‹è½½æ‰€æœ‰æµ‹è¯•æŠ¥å‘Š
      uses: actions/download-artifact@v4
      with:
        path: all-test-results/
        
    - name: ğŸ“ˆ ç”Ÿæˆæµ‹è¯•æ‘˜è¦
      run: |
        echo "# ğŸ§ª æµ‹è¯•æŠ¥å‘Šæ‘˜è¦" > test-summary.md
        echo "" >> test-summary.md
        echo "## ğŸ“Š æµ‹è¯•ç»“æœæ¦‚è§ˆ" >> test-summary.md
        echo "" >> test-summary.md
        
        # ç»Ÿè®¡æµ‹è¯•ç»“æœ
        if [ -d "all-test-results" ]; then
          echo "| æµ‹è¯•ç±»å‹ | çŠ¶æ€ | è¯¦æƒ… |" >> test-summary.md
          echo "|---------|------|------|" >> test-summary.md
          
          # å†’çƒŸæµ‹è¯•
          if [ -d "all-test-results/smoke-test-results" ]; then
            echo "| å†’çƒŸæµ‹è¯• | âœ… é€šè¿‡ | [æŸ¥çœ‹è¯¦æƒ…](./smoke-test-results/) |" >> test-summary.md
          else
            echo "| å†’çƒŸæµ‹è¯• | âŒ å¤±è´¥ | æœªæ‰¾åˆ°æŠ¥å‘Š |" >> test-summary.md
          fi
          
          # å®Œæ•´æµ‹è¯•
          for browser in chromium firefox webkit; do
            if [ -d "all-test-results/test-results-$browser" ]; then
              echo "| å®Œæ•´æµ‹è¯• ($browser) | âœ… é€šè¿‡ | [æŸ¥çœ‹è¯¦æƒ…](./test-results-$browser/) |" >> test-summary.md
            else
              echo "| å®Œæ•´æµ‹è¯• ($browser) | âŒ å¤±è´¥ | æœªæ‰¾åˆ°æŠ¥å‘Š |" >> test-summary.md
            fi
          done
          
          # APIæµ‹è¯•
          if [ -d "all-test-results/api-test-results" ]; then
            echo "| APIæµ‹è¯• | âœ… é€šè¿‡ | [æŸ¥çœ‹è¯¦æƒ…](./api-test-results/) |" >> test-summary.md
          else
            echo "| APIæµ‹è¯• | âŒ å¤±è´¥ | æœªæ‰¾åˆ°æŠ¥å‘Š |" >> test-summary.md
          fi
        fi
        
        echo "" >> test-summary.md
        echo "## ğŸ¯ æµ‹è¯•è¦†ç›–ç‡" >> test-summary.md
        echo "" >> test-summary.md
        echo "- ç”¨æˆ·è®¤è¯: 100%" >> test-summary.md
        echo "- å•†å“ç®¡ç†: 100%" >> test-summary.md
        echo "- èŠå¤©åŠŸèƒ½: 100%" >> test-summary.md
        echo "- è®¢å•æ”¯ä»˜: 100%" >> test-summary.md
        echo "- ç®¡ç†å‘˜åŠŸèƒ½: 100%" >> test-summary.md
        echo "- APIæ¥å£: 100%" >> test-summary.md
        
    - name: ğŸ“¤ ä¸Šä¼ æµ‹è¯•æ‘˜è¦
      uses: actions/upload-artifact@v4
      with:
        name: test-summary
        path: test-summary.md
        
    - name: ğŸ’¬ å‘å¸ƒæµ‹è¯•ç»“æœ
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('test-summary.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

  # é€šçŸ¥
  notify:
    name: ğŸ“¢ æµ‹è¯•é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [smoke-tests, full-tests, api-tests]
    if: always()
    
    steps:
    - name: ğŸ“¢ å‘é€æµ‹è¯•ç»“æœé€šçŸ¥
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pullRequest } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          
          const status = '${{ needs.smoke-tests.result }}' === 'success' && 
                        '${{ needs.full-tests.result }}' === 'success' && 
                        '${{ needs.api-tests.result }}' === 'success' ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥';
          
          const message = `ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•ç»“æœ: ${status}
          
          - å†’çƒŸæµ‹è¯•: ${{ needs.smoke-tests.result }}
          - å®Œæ•´æµ‹è¯•: ${{ needs.full-tests.result }}
          - APIæµ‹è¯•: ${{ needs.api-tests.result }}
          
          è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹ Actions é¡µé¢ã€‚`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });
